name: Android Play Internal (scaffold)

on:
  workflow_dispatch:
    inputs:
      upload_enabled:
        description: "Set true to perform Play Internal upload after validation/build"
        required: false
        default: "false"
      release_status:
        description: "Play release status (completed|inProgress|draft)"
        required: false
        default: "draft"
  push:
    tags:
      - "v*"

permissions:
  contents: read

concurrency:
  group: android-play-internal-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate-build-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve version from VERSION file
        id: version
        shell: bash
        run: |
          set -euo pipefail
          VERSION_FILE="$(tr -d '[:space:]' < VERSION)"
          if [ -z "$VERSION_FILE" ]; then
            echo "VERSION file is empty"
            exit 1
          fi

          if [ "${GITHUB_REF_TYPE:-}" = "tag" ]; then
            TAG_VERSION="${GITHUB_REF_NAME#v}"
            if [ "$TAG_VERSION" != "$VERSION_FILE" ]; then
              echo "Tag/version mismatch: tag=$TAG_VERSION VERSION=$VERSION_FILE"
              exit 1
            fi
          fi

          echo "version=${VERSION_FILE}" >> "$GITHUB_OUTPUT"

      - name: Fail fast on missing distribution secrets
        shell: bash
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          PLAY_PACKAGE_NAME: ${{ secrets.PLAY_PACKAGE_NAME }}
        run: |
          set -euo pipefail
          missing=0
          for key in PLAY_SERVICE_ACCOUNT_JSON PLAY_PACKAGE_NAME; do
            if [ -z "${!key:-}" ]; then
              echo "::error::Missing required secret: $key"
              missing=1
            fi
          done

          if [ "$missing" -ne 0 ]; then
            echo "Configure repo/environment secrets before running this workflow."
            exit 1
          fi

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build release bundle (AAB)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ./gradlew
          ./gradlew bundleRelease
          AAB_PATH="$(find app/build/outputs -type f -name '*.aab' | head -n 1)"
          if [ -z "${AAB_PATH}" ]; then
            echo "::error::No .aab found under app/build/outputs"
            exit 1
          fi
          echo "AAB_PATH=${AAB_PATH}" >> "$GITHUB_ENV"

      - name: Write service account credentials file
        shell: bash
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          set -euo pipefail
          printf '%s' "$PLAY_SERVICE_ACCOUNT_JSON" > "$RUNNER_TEMP/play-service-account.json"

      - name: Upload to Google Play Internal (optional)
        if: ${{ github.event_name == 'push' || inputs.upload_enabled == 'true' }}
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ env.RUNNER_TEMP }}/play-service-account.json
          packageName: ${{ secrets.PLAY_PACKAGE_NAME }}
          releaseFiles: ${{ env.AAB_PATH }}
          track: internal
          status: ${{ inputs.release_status || 'draft' }}

      - name: Scaffold mode summary
        if: ${{ github.event_name != 'push' && inputs.upload_enabled != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "### Android Play Internal scaffold mode"
            echo "- Version: ${{ steps.version.outputs.version }}"
            echo "- AAB built: ${AAB_PATH}"
            echo "- Upload step skipped (upload_enabled=false)."
            echo "- Set upload_enabled=true to execute Play Internal upload."
          } >> "$GITHUB_STEP_SUMMARY"
