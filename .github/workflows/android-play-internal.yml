name: Android Play Internal CD

on:
  workflow_dispatch:
    inputs:
      upload_enabled:
        description: "Set true to upload signed AAB to Play Internal after validation"
        required: false
        default: "false"
      release_status:
        description: "Play release status (completed|inProgress|draft)"
        required: false
        default: "draft"
  push:
    tags:
      - "v*"

permissions:
  contents: read

concurrency:
  group: android-play-internal-${{ github.ref }}
  cancel-in-progress: false

env:
  CI: "true"
  TZ: "UTC"
  LANG: "C.UTF-8"
  LC_ALL: "C.UTF-8"

jobs:
  internal-release:
    name: internal-release
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release intent + validate version consistency
        id: version
        shell: bash
        run: |
          set -euo pipefail
          VERSION_FILE="$(tr -d '[:space:]' < VERSION)"
          if [ -z "$VERSION_FILE" ]; then
            echo "::error::VERSION file is empty"
            exit 1
          fi

          APP_VERSION_NAME="$(grep -E 'versionName\s*=\s*"' app/build.gradle.kts | head -n1 | sed -E 's/.*"([^"]+)".*/\1/')"
          APP_VERSION_CODE="$(grep -E 'versionCode\s*=\s*[0-9]+' app/build.gradle.kts | head -n1 | sed -E 's/.*=\s*([0-9]+).*/\1/')"

          if [ -z "$APP_VERSION_NAME" ] || [ -z "$APP_VERSION_CODE" ]; then
            echo "::error::Failed to parse versionName/versionCode from app/build.gradle.kts"
            exit 1
          fi

          if [ "$APP_VERSION_NAME" != "$VERSION_FILE" ]; then
            echo "::error::versionName ($APP_VERSION_NAME) must match VERSION ($VERSION_FILE)"
            exit 1
          fi

          if ! [[ "$APP_VERSION_CODE" =~ ^[0-9]+$ ]] || [ "$APP_VERSION_CODE" -le 0 ]; then
            echo "::error::versionCode must be a positive integer (found: $APP_VERSION_CODE)"
            exit 1
          fi

          if [ "${GITHUB_REF_TYPE:-}" = "tag" ]; then
            TAG_VERSION="${GITHUB_REF_NAME#v}"
            if [ "$TAG_VERSION" != "$VERSION_FILE" ]; then
              echo "::error::Tag/version mismatch: tag=$TAG_VERSION VERSION=$VERSION_FILE"
              exit 1
            fi
            upload_requested=true
            release_status="${{ inputs.release_status || 'draft' }}"
          else
            upload_requested="${{ inputs.upload_enabled || 'false' }}"
            release_status="${{ inputs.release_status || 'draft' }}"

            if [ "$upload_requested" = "true" ] && [ "${GITHUB_REF:-}" != "refs/heads/main" ]; then
              echo "::error::Manual upload is only allowed from refs/heads/main (found: ${GITHUB_REF:-unknown})"
              exit 1
            fi
          fi

          case "$release_status" in
            completed|inProgress|draft) ;;
            *)
              echo "::error::release_status must be one of: completed, inProgress, draft (found: $release_status)"
              exit 1
              ;;
          esac

          # Enforce strictly increasing versionCode for tag-triggered releases.
          previous_tag="$(git tag -l 'v*' --sort=-version:refname | grep -Fv "${GITHUB_REF_NAME:-}" | head -n1 || true)"
          previous_version_code=""
          if [ -n "$previous_tag" ]; then
            previous_version_code="$(git show "$previous_tag":app/build.gradle.kts 2>/dev/null | grep -E 'versionCode\s*=\s*[0-9]+' | head -n1 | sed -E 's/.*=\s*([0-9]+).*/\1/' || true)"
          fi

          if [ "${GITHUB_REF_TYPE:-}" = "tag" ] && [ -n "$previous_version_code" ]; then
            if ! [[ "$previous_version_code" =~ ^[0-9]+$ ]]; then
              echo "::error::Failed to parse previous tag ($previous_tag) versionCode"
              exit 1
            fi
            if [ "$APP_VERSION_CODE" -le "$previous_version_code" ]; then
              echo "::error::versionCode must increase over previous tag ($previous_tag): current=$APP_VERSION_CODE previous=$previous_version_code"
              exit 1
            fi
          fi

          echo "version=$VERSION_FILE" >> "$GITHUB_OUTPUT"
          echo "version_name=$APP_VERSION_NAME" >> "$GITHUB_OUTPUT"
          echo "version_code=$APP_VERSION_CODE" >> "$GITHUB_OUTPUT"
          echo "previous_tag=${previous_tag:-none}" >> "$GITHUB_OUTPUT"
          echo "previous_version_code=${previous_version_code:-unknown}" >> "$GITHUB_OUTPUT"
          echo "release_status=$release_status" >> "$GITHUB_OUTPUT"
          echo "upload_requested=$upload_requested" >> "$GITHUB_OUTPUT"

      - name: Check required secrets and decide mode
        id: secrets
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          PLAY_PACKAGE_NAME: ${{ secrets.PLAY_PACKAGE_NAME }}
        run: |
          set -euo pipefail
          signing_ready=true
          upload_ready=true
          missing_signing=()
          missing_upload=()

          for key in ANDROID_KEYSTORE_BASE64 ANDROID_KEYSTORE_PASSWORD ANDROID_KEY_ALIAS ANDROID_KEY_PASSWORD; do
            if [ -z "${!key:-}" ]; then
              missing_signing+=("$key")
              signing_ready=false
            fi
          done

          for key in PLAY_SERVICE_ACCOUNT_JSON PLAY_PACKAGE_NAME; do
            if [ -z "${!key:-}" ]; then
              missing_upload+=("$key")
              upload_ready=false
            fi
          done

          echo "signing_ready=$signing_ready" >> "$GITHUB_OUTPUT"
          echo "upload_ready=$upload_ready" >> "$GITHUB_OUTPUT"
          printf 'missing_signing=%s\n' "${missing_signing[*]:-none}" >> "$GITHUB_OUTPUT"
          printf 'missing_upload=%s\n' "${missing_upload[*]:-none}" >> "$GITHUB_OUTPUT"

          if [ "${{ steps.version.outputs.upload_requested }}" = "true" ]; then
            if [ "$signing_ready" != "true" ]; then
              echo "::error::Upload requested but signing secrets are missing: ${missing_signing[*]}"
              exit 1
            fi
            if [ "$upload_ready" != "true" ]; then
              echo "::error::Upload requested but Play secrets are missing: ${missing_upload[*]}"
              exit 1
            fi
          fi

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Prepare keystore for signed build
        if: ${{ steps.secrets.outputs.signing_ready == 'true' }}
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > "$RUNNER_TEMP/upload-keystore.jks"
          test -s "$RUNNER_TEMP/upload-keystore.jks"

      - name: Build release AAB (deterministic flags)
        id: build
        shell: bash
        env:
          ORG_GRADLE_PROJECT_ANDROID_SIGNING_STORE_FILE: ${{ runner.temp }}/upload-keystore.jks
          ORG_GRADLE_PROJECT_ANDROID_SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ORG_GRADLE_PROJECT_ANDROID_SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ORG_GRADLE_PROJECT_ANDROID_SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          chmod +x ./gradlew
          ./gradlew --no-daemon --stacktrace --warning-mode all clean bundleRelease

          AAB_PATH="$(find app/build/outputs/bundle -type f -name '*.aab' | sort | head -n 1)"
          if [ -z "${AAB_PATH}" ]; then
            echo "::error::No .aab found under app/build/outputs/bundle"
            exit 1
          fi

          SHA256="$(sha256sum "$AAB_PATH" | awk '{print $1}')"
          echo "aab_path=$AAB_PATH" >> "$GITHUB_OUTPUT"
          echo "aab_sha256=$SHA256" >> "$GITHUB_OUTPUT"

      - name: Write Play service account credentials file
        if: ${{ steps.secrets.outputs.upload_ready == 'true' }}
        shell: bash
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          set -euo pipefail
          printf '%s' "$PLAY_SERVICE_ACCOUNT_JSON" > "$RUNNER_TEMP/play-service-account.json"

      - name: Build release metadata
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          cat > build/release-metadata.txt <<EOF
          workflow=android-play-internal
          version=${{ steps.version.outputs.version }}
          versionName=${{ steps.version.outputs.version_name }}
          versionCode=${{ steps.version.outputs.version_code }}
          previous_tag=${{ steps.version.outputs.previous_tag }}
          previous_versionCode=${{ steps.version.outputs.previous_version_code }}
          release_status=${{ steps.version.outputs.release_status }}
          ref=${GITHUB_REF}
          ref_name=${GITHUB_REF_NAME}
          sha=${GITHUB_SHA}
          actor=${GITHUB_ACTOR}
          run_id=${GITHUB_RUN_ID}
          run_number=${GITHUB_RUN_NUMBER}
          run_attempt=${GITHUB_RUN_ATTEMPT}
          run_url=${RUN_URL}
          aab_path=${{ steps.build.outputs.aab_path }}
          aab_sha256=${{ steps.build.outputs.aab_sha256 }}
          upload_requested=${{ steps.version.outputs.upload_requested }}
          signing_ready=${{ steps.secrets.outputs.signing_ready }}
          upload_ready=${{ steps.secrets.outputs.upload_ready }}
          missing_signing=${{ steps.secrets.outputs.missing_signing }}
          missing_upload=${{ steps.secrets.outputs.missing_upload }}
          EOF

          cat > build/release-metadata.json <<EOF
          {
            "workflow": "android-play-internal",
            "version": "${{ steps.version.outputs.version }}",
            "versionName": "${{ steps.version.outputs.version_name }}",
            "versionCode": "${{ steps.version.outputs.version_code }}",
            "previous_tag": "${{ steps.version.outputs.previous_tag }}",
            "previous_versionCode": "${{ steps.version.outputs.previous_version_code }}",
            "release_status": "${{ steps.version.outputs.release_status }}",
            "ref": "${GITHUB_REF}",
            "ref_name": "${GITHUB_REF_NAME}",
            "sha": "${GITHUB_SHA}",
            "actor": "${GITHUB_ACTOR}",
            "run_id": "${GITHUB_RUN_ID}",
            "run_number": "${GITHUB_RUN_NUMBER}",
            "run_attempt": "${GITHUB_RUN_ATTEMPT}",
            "run_url": "${RUN_URL}",
            "aab_path": "${{ steps.build.outputs.aab_path }}",
            "aab_sha256": "${{ steps.build.outputs.aab_sha256 }}",
            "upload_requested": "${{ steps.version.outputs.upload_requested }}",
            "signing_ready": "${{ steps.secrets.outputs.signing_ready }}",
            "upload_ready": "${{ steps.secrets.outputs.upload_ready }}",
            "missing_signing": "${{ steps.secrets.outputs.missing_signing }}",
            "missing_upload": "${{ steps.secrets.outputs.missing_upload }}"
          }
          EOF

          cat > build/evidence-prefill.md <<EOF
          ## Release identity
          - Date/UTC: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - Operator: ${GITHUB_ACTOR}
          - Version (\`VERSION\`/\`versionName\`): ${{ steps.version.outputs.version }}
          - \`versionCode\`: ${{ steps.version.outputs.version_code }}
          - Previous tag: ${{ steps.version.outputs.previous_tag }}
          - Previous \`versionCode\`: ${{ steps.version.outputs.previous_version_code }}
          - Tag pushed: ${GITHUB_REF_NAME}
          - Target commit SHA: ${GITHUB_SHA}

          ## Dry-run evidence (required)
          - Workflow URL (dispatch, \`upload_enabled=false\`): ${RUN_URL}
          - Result: 
          - Artifact name: capture-android-play-internal-${{ steps.version.outputs.version }}
          - \`aab_sha256\` from metadata: ${{ steps.build.outputs.aab_sha256 }}
          - Validation notes: 

          ## Upload run evidence
          - Workflow URL (tag-triggered): ${RUN_URL}
          - Result: 
          - \`release_status\` used: ${{ steps.version.outputs.release_status }}
          - Upload requested = true (yes/no): ${{ steps.version.outputs.upload_requested }}
          - Missing secrets reported (should be \`none\`): signing=${{ steps.secrets.outputs.missing_signing }} upload=${{ steps.secrets.outputs.missing_upload }}
          EOF

          cat > build/evidence-handoff.md <<EOF
          # Evidence handoff payload (paste into release PR/issue)

          ## Release identity
          - Date/UTC: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - Operator: ${GITHUB_ACTOR}
          - Target commit SHA: ${GITHUB_SHA}
          - Version (\`VERSION\`/\`versionName\`): ${{ steps.version.outputs.version }}
          - \`versionCode\`: ${{ steps.version.outputs.version_code }}
          - Previous tag: ${{ steps.version.outputs.previous_tag }}
          - Previous \`versionCode\`: ${{ steps.version.outputs.previous_version_code }}
          - Tag pushed: ${GITHUB_REF_NAME}

          ## Dry-run evidence (required)
          - Workflow URL (dispatch, \`upload_enabled=false\`): ${RUN_URL}
          - Result: pass/fail
          - Artifact name: capture-android-play-internal-${{ steps.version.outputs.version }}
          - \`aab_sha256\` from metadata: ${{ steps.build.outputs.aab_sha256 }}
          - \`run_attempt\`: ${GITHUB_RUN_ATTEMPT}
          - Validation notes:

          ## Upload run evidence
          - Workflow URL (tag-triggered): ${RUN_URL}
          - Result: pass/fail
          - \`release_status\` used: ${{ steps.version.outputs.release_status }}
          - Upload requested = true (yes/no): ${{ steps.version.outputs.upload_requested }}
          - Missing secrets reported (should be \`none\`): signing=${{ steps.secrets.outputs.missing_signing }} upload=${{ steps.secrets.outputs.missing_upload }}
          EOF

      - name: Upload release bundle + metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: capture-android-play-internal-${{ steps.version.outputs.version }}
          path: |
            ${{ steps.build.outputs.aab_path }}
            build/release-metadata.txt
            build/release-metadata.json
            build/evidence-prefill.md
            build/evidence-handoff.md
          if-no-files-found: error
          retention-days: 30
          overwrite: true

      - name: Upload to Google Play Internal
        if: ${{ steps.version.outputs.upload_requested == 'true' && steps.secrets.outputs.upload_ready == 'true' }}
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ env.RUNNER_TEMP }}/play-service-account.json
          packageName: ${{ secrets.PLAY_PACKAGE_NAME }}
          releaseFiles: ${{ steps.build.outputs.aab_path }}
          track: internal
          status: ${{ steps.version.outputs.release_status }}

      - name: Run summary
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "### Android Play Internal CD"
            echo ""
            echo "| Signal | Value |"
            echo "|---|---|"
            echo "| Version | ${{ steps.version.outputs.version }} |"
            echo "| versionName / versionCode | ${{ steps.version.outputs.version_name }} / ${{ steps.version.outputs.version_code }} |"
            echo "| Previous tag / versionCode | ${{ steps.version.outputs.previous_tag }} / ${{ steps.version.outputs.previous_version_code }} |"
            echo "| Upload requested | ${{ steps.version.outputs.upload_requested }} |"
            echo "| Release status | ${{ steps.version.outputs.release_status }} |"
            echo "| Signing secrets ready | ${{ steps.secrets.outputs.signing_ready }} |"
            echo "| Upload secrets ready | ${{ steps.secrets.outputs.upload_ready }} |"
            echo "| AAB sha256 | `${{ steps.build.outputs.aab_sha256 }}` |"
            echo ""
            echo "**Workflow summary**"
            if [ "${{ steps.version.outputs.upload_requested }}" = "true" ]; then
              echo "- ✅ Upload path requested."
            else
              echo "- ℹ️ Dry-run path only (`upload_enabled=false`)."
            fi
            if [ "${{ steps.secrets.outputs.signing_ready }}" = "true" ] && [ "${{ steps.secrets.outputs.upload_ready }}" = "true" ]; then
              echo "- ✅ Required secrets available for live upload."
            else
              echo "- ⚠️ Placeholder mode active. Missing secrets are captured in metadata artifact."
            fi
            echo ""
            echo "**Evidence handoff**"
            echo "- Download artifact: `capture-android-play-internal-${{ steps.version.outputs.version }}`"
            echo "- Paste-ready handoff file: `build/evidence-handoff.md`"
            echo "- Metadata source of truth: `build/release-metadata.json`"
            echo ""
            echo "**Next operator action**"
            if [ "${{ steps.version.outputs.upload_requested }}" != "true" ]; then
              echo "1. Copy `build/evidence-handoff.md` into your release PR/issue evidence section."
              echo "2. Complete approvals in docs/release-governance-checklist.md."
              echo "3. Push tag `v${{ steps.version.outputs.version }}` when GO is confirmed."
            else
              echo "1. Confirm Play Internal shows versionCode `${{ steps.version.outputs.version_code }}`."
              echo "2. Complete QA sign-off + GO/NO-GO + rollback readiness evidence."
            fi
            echo ""
            echo "Operator docs: docs/android-first-internal-rollout-execution-pack.md"
          } >> "$GITHUB_STEP_SUMMARY"
